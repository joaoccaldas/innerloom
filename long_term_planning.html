<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Innerloom LTP - Debugging Render</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif; background: #f9f9f9; color: #333;
      margin: 0; padding: 20px; font-weight: 300;
    }
    .container { max-width: 98%; margin: 0 auto; } 
    .page-header { text-align: center; margin-bottom: 25px; }
    .page-header h1 { font-size: 2em; color: #65C9C2; font-weight:700; margin-bottom:5px;}
    .page-header p { font-size: 1em; color: #555; margin-top:0;}

    .section {
      background: #fff; padding: 25px; margin-bottom: 25px;
      border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .section h2 { font-size: 1.4em; margin-bottom: 20px; color: #65C9C2; font-weight:600; border-bottom: 1px solid #e0f2f1; padding-bottom:10px;}
    
    .input-grid-container { overflow-x: auto; }
    .ltp-input-table { width: 100%; min-width: 1500px; border-collapse: collapse; font-size: 0.8em; } 
    .ltp-input-table th, .ltp-input-table td {
      border: 1px solid #e0e0e0; padding: 6px; text-align: right;
    }
    .ltp-input-table th { background-color: #f0f7f7; font-weight: 600; white-space: nowrap; position: sticky; top: 0; z-index:10;}
    .ltp-input-table td input[type="number"] {
      width: 90%; padding: 4px; font-size: 1em; text-align: right; border-radius:3px; border:1px solid #ccc;
      box-sizing: border-box; -moz-appearance: textfield; /* Firefox */
    }
    .ltp-input-table td input[type="number"]::-webkit-outer-spin-button,
    .ltp-input-table td input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none; margin: 0; /* Safari and Chrome */
    }
    .ltp-input-table td input.growth-perc-input {
        width: 60px; 
        background-color: #fff9e6; 
    }
    .ltp-input-table .row-header { 
        text-align: left; font-weight: 500; background-color: #f8fbfb; 
        min-width:180px;
        position: sticky; left: 0; z-index: 5; 
        background-clip: padding-box; 
    }
    .ltp-input-table .category-header { 
        text-align: left; font-weight: bold; background-color: #e8f8f7; color:#004d40; 
        position: sticky; left:0; z-index:5;
        background-clip: padding-box; 
    }
    .ltp-input-table .year-total-col { font-weight: bold; background-color: #f0f7f7; }
    .ltp-input-table .growth-header-col { background-color: #fff0e0; font-size:0.9em; } 
    
    .summary-pnl-table { width:100%; border-collapse:collapse; margin-top:20px; font-size:0.9em;}
    .summary-pnl-table th, .summary-pnl-table td { border:1px solid #ddd; padding:10px; text-align:right;}
    .summary-pnl-table th { background-color:#e8f8f7; }
    .summary-pnl-table .row-header { text-align:left; font-weight:500;}
    .summary-pnl-table .yoy-growth { font-size:0.8em; color:#777; font-style:italic;}
    .green { color: #28a745; } .red { color: #dc3545; }

    textarea#ltpAssumptions { width: calc(100% - 22px); min-height: 80px; margin-top:10px; padding:10px; border-radius:5px; border:1px solid #ccc; font-size:0.9em;}
    button.control-button {
      padding: 10px 20px; background-color: #65C9C2; color: white; border: none;
      border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: 600;
      margin-top: 15px; margin-right:10px; transition: background-color 0.2s ease;
    }
    button.control-button:hover { background-color: #5ABBAD; }
    .chart-container { 
        margin-top:20px; padding:15px; background-color:#fdfdff; 
        border:1px solid #e0e8e7; border-radius:8px;
        position: relative; /* For Chart.js responsive behavior */
        aspect-ratio: 16 / 10; /* Constrain aspect ratio to prevent uncontrolled growth */
        min-height: 300px; /* Ensure a minimum height */
    }
    .charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:20px; } 
    .no-data-warning { color: #a94442; background-color: #f2dede; padding: 15px; border-radius: 5px; text-align: center; margin:15px 0;}
    .nav-links { text-align:center; margin-bottom:20px;}
    .nav-links a { margin:0 10px; color:#65C9C2; text-decoration:none; font-weight:600; }
    .info-text { font-size:0.9em; color: #555; margin-bottom:15px;}
  </style>
</head>
<body>
<nav class="main-menu">
  <ul>
    <li><a href="landing.html">Inner Loom roadmap</a></li>
    <li><a href="funding_strategy.html">Funding Ecosystem</a></li>
    <li><a href="revenue_input.html">Revenue modeling</a></li>
    <li><a href="costs_input.html">Costs modeling</a></li>
    <li><a href="financial_dashboard.html">Inner Loom Financials</a></li>
  </ul>
</nav>
<div class="container">
    <div class="page-header">
        <h1>Innerloom Long-Term Financial Plan</h1>
        <p>Quarterly Planning with Growth Drivers (2025 - 2029)</p>
        <div class="nav-links">
            <a href="financial_dashboard.html">Â« Back to Main Dashboard</a>
        </div>
    </div>

    <div id="initialDataWarning" class="no-data-warning" style="display:none;">
        Warning: Year 1 (2025) pre-population requires data from the main Financial Dashboard. Please ensure cost and revenue inputs are saved there.
    </div>

    <div class="section">
        <h2>Overall Long-Term Assumptions & Growth</h2>
        <label for="ltpDefaultGrowthRate">Default Annual Growth Rate for Subsequent Years (%):</label>
        <input type="number" id="ltpDefaultGrowthRate" value="5" style="width:100px; margin-bottom:10px;" onchange="handleDefaultGrowthChange()">
        <textarea id="ltpAssumptions" placeholder="Enter key strategic assumptions for the 2025-2029 period..."></textarea>
    </div>

    <div class="section">
        <h2>Quarterly Input Grid (SEK)</h2>
        <p class="info-text">
            Year 1 (2025) is pre-populated. For subsequent years, the annual total is driven by the previous year's annual total and the "Growth %" input. Quarters are then auto-filled (Annual/4) but can be manually overridden.
            Manually changing a quarterly input will update its year's annual total. To re-apply growth logic for subsequent years based on a manual change, click "Recalculate & Apply All Growth".
        </p>
        <div class="input-grid-container">
            <table class="ltp-input-table" id="ltpInputTable">
                <thead>
                    <tr>
                        <th style="position:sticky; left:0; z-index:20; background-color: #f0f7f7;">Item</th>
                        <!-- Headers will be generated by JS -->
                    </tr>
                </thead>
                <tbody id="ltpInputTableBody">
                    <!-- Rows will be generated by JS -->
                </tbody>
            </table>
        </div>
        <button class="control-button" onclick="saveLtpData()">Save Long-Term Plan</button>
        <button class="control-button" onclick="fullRecalculationFromGrowthInputs()" style="background-color:#5ABBAD;">Recalculate & Apply All Growth</button>
        <button class="control-button" onclick="recalculateAndDisplayLtp()" style="background-color:#778899;">Refresh Summaries & Charts</button>
    </div>

    <div class="section">
        <h2>Long-Term P&L Summary (Annual)</h2>
        <div class="input-grid-container">
            <table class="summary-pnl-table" id="ltpSummaryPnlTable">
                <thead><tr><th>Description</th></tr></thead>
                <tbody id="ltpSummaryPnlTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="section">
        <h2>Long-Term Cash Flow Outlook (Simplified, Annual)</h2>
        <p class="info-text">Based on dashboard's starting cash for 2025, P&L Net Result as proxy for net cash flow.</p>
        <div class="input-grid-container">
            <table class="summary-pnl-table" id="ltpCashFlowTable">
                <thead><tr><th>Description</th></tr></thead>
                <tbody id="ltpCashFlowTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="section">
        <h2>Long-Term Financial Charts</h2>
        <div class="charts-grid">
            <div class="chart-container"><h3>P&L Trend (2025-2029)</h3><canvas id="ltpPnlTrendChart"></canvas></div>
            <div class="chart-container"><h3>Revenue Mix by Year</h3><canvas id="ltpRevenueMixChart"></canvas></div>
            <div class="chart-container"><h3>Expense Mix by Year</h3><canvas id="ltpExpenseMixChart"></canvas></div>
        </div>
    </div>
</div>

<script>
    console.log("LTP Script: Starting execution.");
    // --- Configuration ---
    const START_YEAR = 2025;
    const NUM_YEARS = 5;
    const QUARTERS = ['Q1', 'Q2', 'Q3', 'Q4'];
    const YEARS = Array.from({length: NUM_YEARS}, (_, i) => START_YEAR + i);

    const LTP_REVENUE_STREAMS = [
      { id: 'crowdfunding', name: 'Crowdfunding' }, { id: 'donations', name: 'Donations' },
      { id: 'grants', name: 'Grants' }, { id: 'serviceFees', name: 'Service Fees' },
      { id: 'trainTheTrainer', name: 'Train-the-Trainer' }, { id: 'membershipFees', name: 'Membership Fees' },
      { id: 'events', name: 'Events' }, { id: 'otherIncome', name: 'Other Income' }
    ];
    const LTP_OPCOST_CATEGORIES = [
        { id: 'techWeb', name: 'Tech & Web' },
        { id: 'officeAdmin', name: 'Office & Admin' },
        { id: 'profServices', name: 'Prof. Services & Insurance' }
    ];
    const LTP_STAFF_COST_ID = 'totalStaffCosts';
    
    let activeCharts = {}; // Store active chart instances
    let isCalculating = false; 

    // --- Helper Functions ---
    function formatSEK_ltp(value) { return (Number(value) || 0).toLocaleString('sv-SE', { style: 'currency', currency: 'SEK', maximumFractionDigits: 0 }); }
    function formatPercentage_ltp(value) { return (Number(value) || 0).toFixed(1) + '%'; }
    function parseFormattedSEK(sekString) {
        if (typeof sekString !== 'string') return 0;
        // For 'sv-SE' like "1 234,56 kr": remove non-digits/non-comma, then replace comma with dot.
        const numStr = sekString.replace(/[^0-9,]/g, '').replace(',', '.');
        const num = parseFloat(numStr);
        return Number.isNaN(num) ? 0 : num;
    }

    // --- DOM Ready & Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("LTP Script: DOMContentLoaded event fired.");
        try {
            generateLtpInputTableStructure();
            loadAndPrepopulateLtpData(); // This will also trigger initial calculations and chart rendering
        } catch (e) {
            console.error("LTP Script: Error during initial setup:", e);
            const warningDiv = document.getElementById('initialDataWarning');
            if(warningDiv) {
                 warningDiv.textContent = "Critical error during page initialization. Check console.";
                 warningDiv.style.display = 'block';
            }
        }
        console.log("LTP Script: Initial setup functions called.");
    });

    function generateLtpInputTableStructure() {
        console.log("LTP Script: generateLtpInputTableStructure - START");
        const table = document.getElementById('ltpInputTable');
        const thead = table.querySelector('thead tr');
        const tbody = document.getElementById('ltpInputTableBody');
        
        if(!table || !thead || !tbody) {
            console.error("LTP Script: generateLtpInputTableStructure - Table elements not found!");
            return;
        }
        
        let headerHtml = '<th style="position:sticky; left:0; z-index:20; background-color: #f0f7f7;">Item</th>';
        YEARS.forEach((year, yearIndex) => {
            QUARTERS.forEach(q => headerHtml += `<th>${year} ${q}</th>`);
            headerHtml += `<th class="year-total-col">${year} Annual</th>`;
            if (yearIndex < NUM_YEARS - 1) { 
                headerHtml += `<th class="growth-header-col">Growth % for ${year + 1}</th>`;
            }
        });
        thead.innerHTML = headerHtml;
        
        let bodyHtml = '';
        const allItemsConfig = [
            {header: "REVENUE STREAMS", items: LTP_REVENUE_STREAMS, prefix: "rev"},
            {header: "STAFF COSTS", items: [{id: LTP_STAFF_COST_ID, name: "Total Staff Costs"}], prefix: "cost"},
            {header: "OPERATING COSTS", items: LTP_OPCOST_CATEGORIES, prefix: "cost"}
        ];

        const numQuarterCols = QUARTERS.length * NUM_YEARS;
        const numAnnualCols = NUM_YEARS;
        const numGrowthCols = NUM_YEARS - 1;
        const totalDataCols = numQuarterCols + numAnnualCols + numGrowthCols;

        allItemsConfig.forEach(section => {
            bodyHtml += `<tr><td colspan="${1 + totalDataCols}" class="category-header">${section.header}</td></tr>`;
            
            section.items.forEach(item => {
                bodyHtml += `<tr class="data-row" data-type="${section.prefix === 'rev' ? 'revenue' : 'cost'}" data-id="${item.id}"><td class="row-header">${item.name}</td>`;
                YEARS.forEach((year, yearIndex) => {
                    QUARTERS.forEach(q => bodyHtml += `<td><input type="number" id="${section.prefix}_${item.id}_${year}_${q}" value="0" oninput="this.value = this.value.replace(/[^0-9-]/g, '')" onchange="handleQuarterlyInputChange('${item.id}', ${year}, '${section.prefix}')"></td>`);
                    bodyHtml += `<td id="${section.prefix}_annual_${item.id}_${year}" class="year-total-col">${formatSEK_ltp(0)}</td>`;
                    if (yearIndex < NUM_YEARS - 1) {
                        bodyHtml += `<td><input type="number" class="growth-perc-input" id="growth_${section.prefix}_${item.id}_${year + 1}" value="0" step="0.1" title="Growth % for ${item.name} in ${year+1}" onchange="handleGrowthInputChange('${item.id}', ${year + 1}, '${section.prefix}')"></td>`;
                    }
                });
                bodyHtml += `</tr>`;
            });
        });
        tbody.innerHTML = bodyHtml;
        console.log("LTP Script: generateLtpInputTableStructure - END");
    }
    
    function handleQuarterlyInputChange(itemId, year, typePrefix) {
        if (isCalculating) { console.log("LTP Script: handleQuarterlyInputChange - SKIPPED (isCalculating)"); return; }
        console.log(`LTP Script: handleQuarterlyInputChange - ${itemId}, ${year}, ${typePrefix}`);
        isCalculating = true;
        try {
            sumQuartersToAnnualAndUpdateDisplay(itemId, year, typePrefix); 
            if (year < YEARS[NUM_YEARS - 1]) {
                propagateGrowthFromYear(itemId, year + 1, typePrefix); 
            }
            recalculateAndDisplayLtp(); 
        } catch(e) {
            console.error("Error in handleQuarterlyInputChange:", e);
        } finally {
            isCalculating = false;
            console.log(`LTP Script: handleQuarterlyInputChange - END - ${itemId}`);
        }
    }
    
    function handleGrowthInputChange(itemId, targetYear, typePrefix) {
        if (isCalculating) { console.log("LTP Script: handleGrowthInputChange - SKIPPED (isCalculating)"); return; }
        console.log(`LTP Script: handleGrowthInputChange - ${itemId}, ${targetYear}, ${typePrefix}`);
        isCalculating = true;
        try {
            propagateGrowthFromYear(itemId, targetYear, typePrefix); 
            recalculateAndDisplayLtp(); 
        } catch(e) {
            console.error("Error in handleGrowthInputChange:", e);
        } finally {
            isCalculating = false;
            console.log(`LTP Script: handleGrowthInputChange - END - ${itemId}`);
        }
    }

    function sumQuartersToAnnualAndUpdateDisplay(itemId, year, typePrefix) {
        let annualTotal = 0;
        QUARTERS.forEach(q => {
            const qInput = document.getElementById(`${typePrefix}_${itemId}_${year}_${q}`);
            annualTotal += parseFloat(qInput ? qInput.value : 0) || 0;
        });
        const annualCell = document.getElementById(`${typePrefix}_annual_${itemId}_${year}`);
        if (annualCell) annualCell.textContent = formatSEK_ltp(annualTotal);
        return annualTotal;
    }
    
    function propagateGrowthFromYear(itemId, startPropagationYear, typePrefix) {
        for (let year = startPropagationYear; year <= YEARS[NUM_YEARS - 1]; year++) {
            const prevYear = year - 1;
            const prevYearAnnualCell = document.getElementById(`${typePrefix}_annual_${itemId}_${prevYear}`);
            const growthInput = document.getElementById(`growth_${typePrefix}_${itemId}_${year}`);

            if (!prevYearAnnualCell || !growthInput) {
                console.warn(`propagateGrowthFromYear: Missing DOM element for ${itemId}, year ${year}`);
                continue;
            }

            const prevYearAnnualValue = parseFormattedSEK(prevYearAnnualCell.textContent);
            const growthPercentage = parseFloat(growthInput.value) || 0;
            
            const newAnnualTotal = prevYearAnnualValue * (1 + growthPercentage / 100);
            const quarterlyValue = Math.round(newAnnualTotal / 4); // Use Math.round for whole numbers

            QUARTERS.forEach(q => {
                const qInput = document.getElementById(`${typePrefix}_${itemId}_${year}_${q}`);
                if (qInput) qInput.value = quarterlyValue;
            });
            const targetAnnualCell = document.getElementById(`${typePrefix}_annual_${itemId}_${year}`);
            // Recalculate annual total from potentially rounded quarterly values to ensure consistency
            if(targetAnnualCell) {
                 let sumOfQuarters = 0;
                 QUARTERS.forEach(q => {
                    const qInput = document.getElementById(`${typePrefix}_${itemId}_${year}_${q}`);
                    sumOfQuarters += parseFloat(qInput ? qInput.value : 0) || 0;
                 });
                 targetAnnualCell.textContent = formatSEK_ltp(sumOfQuarters);
            }
        }
    }

    function handleDefaultGrowthChange() {
        if (isCalculating) { console.log("LTP Script: handleDefaultGrowthChange - SKIPPED (isCalculating)"); return; }
        console.log("LTP Script: handleDefaultGrowthChange - START");
        isCalculating = true;
        try {
            const defaultGrowth = parseFloat(document.getElementById('ltpDefaultGrowthRate').value) || 0;
            document.querySelectorAll('input.growth-perc-input').forEach(input => {
                input.value = defaultGrowth;
            });
            fullRecalculationFromGrowthInputs(); 
        } catch(e) {
            console.error("Error in handleDefaultGrowthChange:", e);
        } finally {
            isCalculating = false;
            console.log("LTP Script: handleDefaultGrowthChange - END");
        }
    }

    function fullRecalculationFromGrowthInputs() {
        if (isCalculating) { console.log("LTP Script: fullRecalculationFromGrowthInputs - SKIPPED (isCalculating)"); return; }
        console.log("LTP Script: fullRecalculationFromGrowthInputs - START");
        isCalculating = true;
        try {
            document.querySelectorAll('.data-row').forEach(row => {
                const typePrefix = row.dataset.type === 'revenue' ? 'rev' : 'cost';
                const itemId = row.dataset.id;
                sumQuartersToAnnualAndUpdateDisplay(itemId, START_YEAR, typePrefix);
            });

            document.querySelectorAll('.data-row').forEach(row => {
                const typePrefix = row.dataset.type === 'revenue' ? 'rev' : 'cost';
                const itemId = row.dataset.id;
                propagateGrowthFromYear(itemId, START_YEAR + 1, typePrefix);
            });
            recalculateAndDisplayLtp();
        } catch(e) {
            console.error("Error in fullRecalculationFromGrowthInputs:", e);
        } finally {
            isCalculating = false;
            console.log("LTP Script: fullRecalculationFromGrowthInputs - END");
        }
    }

    function loadAndPrepopulateLtpData() {
        console.log("LTP Script: loadAndPrepopulateLtpData - START");
        if (isCalculating) { console.warn("loadAndPrepopulateLtpData skipped, isCalculating true"); return; }
        isCalculating = true;
        try {
            const costInputsRaw = JSON.parse(localStorage.getItem('innerloomCostInputs'));
            const revenueInputsAdvancedRaw = JSON.parse(localStorage.getItem('innerloomRevenueInputsAdvanced'));
            const warningDiv = document.getElementById('initialDataWarning');
            
            // Pre-populate Year 1 from dashboard data
            if (costInputsRaw && revenueInputsAdvancedRaw && revenueInputsAdvancedRaw.monthlyInputs) {
                if(warningDiv) warningDiv.style.display = 'none';
                
                const netSalaryPerEmp = costInputsRaw.netSalary || 0; 
                const numEmployees = costInputsRaw.numEmployees || 0;
                const avgTaxRate = costInputsRaw.avgIncomeTaxRate || 0;
                const grossSalaryPerEmp = (avgTaxRate < 1 && avgTaxRate > 0 && (1-avgTaxRate) !==0) ? (netSalaryPerEmp / (1 - avgTaxRate)) : netSalaryPerEmp;
                const totalCostPerEmployeeMonthly = grossSalaryPerEmp * (1 + (costInputsRaw.socialSecurityRate||0) + (costInputsRaw.holidayPayRate||0) +
                                                    ((costInputsRaw.includePension ? (costInputsRaw.pensionRate||0) : 0)) + (costInputsRaw.privateInsurancePerc||0));
                const y1AnnualStaffCost = (totalCostPerEmployeeMonthly * numEmployees) * 12;
                const y1StaffCostQuarterly = Math.round(y1AnnualStaffCost / 4);
                QUARTERS.forEach(q => { const el = document.getElementById(`cost_${LTP_STAFF_COST_ID}_${START_YEAR}_${q}`); if(el) el.value = y1StaffCostQuarterly; });
                sumQuartersToAnnualAndUpdateDisplay(LTP_STAFF_COST_ID, START_YEAR, 'cost');

                const opCostMapForCat = { 'techWeb': ['op_email', 'op_canva', 'op_domain', 'op_webDev', 'op_chatgpt'], 'officeAdmin': ['op_bank', 'op_phone', 'op_computer', 'op_office', 'op_supplies', 'op_admin'], 'profServices': ['op_accounting', 'op_insurance']};
                LTP_OPCOST_CATEGORIES.forEach(category => {
                    let catAnnualY1 = 0;
                    if(opCostMapForCat[category.id]){ opCostMapForCat[category.id].forEach(opKey => { catAnnualY1 += (costInputsRaw[opKey] || 0) * 12; }); }
                    const quarterlyVal = Math.round(catAnnualY1 / 4);
                    QUARTERS.forEach(q => { const el = document.getElementById(`cost_${category.id}_${START_YEAR}_${q}`); if(el) el.value = quarterlyVal; });
                    sumQuartersToAnnualAndUpdateDisplay(category.id, START_YEAR, 'cost');
                });

                LTP_REVENUE_STREAMS.forEach(stream => { 
                    const streamData = revenueInputsAdvancedRaw.monthlyInputs[stream.id];
                    const y1AnnualStreamVal = streamData ? streamData.reduce((sum, val) => sum + (val || 0), 0) : 0;
                    const quarterlyVal = Math.round(y1AnnualStreamVal / 4);
                    QUARTERS.forEach(q => { const el = document.getElementById(`rev_${stream.id}_${START_YEAR}_${q}`); if(el) el.value = quarterlyVal; });
                    sumQuartersToAnnualAndUpdateDisplay(stream.id, START_YEAR, 'rev');
                });
                console.log("LTP Script: Y1 Pre-populated from dashboard data.");
            } else {
                if(warningDiv) warningDiv.style.display = 'block';
                console.warn("LTP Script: Y1 Pre-population failed - missing dashboard data.");
            }

            const savedLtp = localStorage.getItem('innerloomLtpData');
            const defaultGrowthRateInput = document.getElementById('ltpDefaultGrowthRate');
            
            if (savedLtp) {
                console.log("LTP Script: Loading saved LTP data.");
                const ltpData = JSON.parse(savedLtp);
                if (ltpData.defaultGrowthRate !== undefined && defaultGrowthRateInput) defaultGrowthRateInput.value = ltpData.defaultGrowthRate;
                
                if (ltpData.inputs) {
                    document.querySelectorAll('.ltp-input-table input[type="number"]').forEach(input => {
                        if (ltpData.inputs[input.id] !== undefined) input.value = ltpData.inputs[input.id];
                    });
                }
                const ltpAssumptionsEl = document.getElementById('ltpAssumptions');
                if (ltpData.assumptions && ltpAssumptionsEl) ltpAssumptionsEl.value = ltpData.assumptions;
                console.log("LTP Script: Saved LTP data applied to inputs.");
            } else {
                console.log("LTP Script: No saved LTP data found. Applying default growth rate from UI.");
                if(defaultGrowthRateInput){
                    const defaultGrowth = parseFloat(defaultGrowthRateInput.value) || 0;
                    document.querySelectorAll('input.growth-perc-input').forEach(input => input.value = defaultGrowth );
                }
            }
            
            // Consistently apply all calculations based on the final state of inputs
            fullRecalculationFromGrowthInputs(); 
            // Note: fullRecalculationFromGrowthInputs itself calls recalculateAndDisplayLtp at its end.
            
        } catch (e) {
            console.error("LTP Script: Error in loadAndPrepopulateLtpData:", e);
        } finally {
            isCalculating = false;
            console.log("LTP Script: loadAndPrepopulateLtpData - END");
        }
    }

    function saveLtpData() { 
        console.log("LTP Script: saveLtpData - START");
        if (isCalculating) { console.warn("Save attempt while calculating, skipping."); return; }
        isCalculating = true;
        try {
            const ltpData = { inputs: {}, assumptions: '', defaultGrowthRate: 0 };
            document.querySelectorAll('.ltp-input-table input[type="number"]').forEach(input => { 
                ltpData.inputs[input.id] = parseFloat(input.value) || 0;
            });
            const ltpAssumptionsEl = document.getElementById('ltpAssumptions');
            if (ltpAssumptionsEl) ltpData.assumptions = ltpAssumptionsEl.value.trim();
            const defaultGrowthRateEl = document.getElementById('ltpDefaultGrowthRate');
            if (defaultGrowthRateEl) ltpData.defaultGrowthRate = parseFloat(defaultGrowthRateEl.value) || 0;
            
            localStorage.setItem('innerloomLtpData', JSON.stringify(ltpData));
            alert('Long-Term Plan data saved!');
        } catch (e) {
            console.error("LTP Script: Error saving LTP data:", e);
            alert('Error saving data. Please check console.');
        } finally {
            isCalculating = false;
            console.log("LTP Script: saveLtpData - END");
        }
    }

    function recalculateAndDisplayLtp() { 
        console.log("LTP Script: recalculateAndDisplayLtp - START");
        try {
            const annualData = {}; 
            YEARS.forEach(year => {
                annualData[year] = { revenues: {}, staffCost: 0, opCostsByCategory: {}, totalRevenue: 0, totalExpenses: 0, netResult: 0 };
                LTP_REVENUE_STREAMS.forEach(stream => {
                    const annualCell = document.getElementById(`rev_annual_${stream.id}_${year}`);
                    const streamAnnual = annualCell ? parseFormattedSEK(annualCell.textContent) : 0;
                    annualData[year].revenues[stream.id] = streamAnnual;
                    annualData[year].totalRevenue += streamAnnual;
                });

                const staffAnnualCell = document.getElementById(`cost_annual_${LTP_STAFF_COST_ID}_${year}`);
                annualData[year].staffCost = staffAnnualCell ? parseFormattedSEK(staffAnnualCell.textContent) : 0;
                annualData[year].totalExpenses += annualData[year].staffCost;

                LTP_OPCOST_CATEGORIES.forEach(category => {
                    const catAnnualCell = document.getElementById(`cost_annual_${category.id}_${year}`);
                    const catAnnual = catAnnualCell ? parseFormattedSEK(catAnnualCell.textContent) : 0;
                    annualData[year].opCostsByCategory[category.id] = catAnnual;
                    annualData[year].totalExpenses += catAnnual;
                });
                annualData[year].netResult = annualData[year].totalRevenue - annualData[year].totalExpenses;
            });

            renderLtpSummaryPnlTable(annualData);
            renderLtpCashFlowTable(annualData);
            renderLtpCharts(annualData);
        } catch (e) {
            console.error("LTP Script: Error in recalculateAndDisplayLtp:", e);
        }
        console.log("LTP Script: recalculateAndDisplayLtp - END");
    }
    
    function renderLtpCharts(annualData) { 
        console.log("LTP Script: renderLtpCharts - START");
        try {
            const chartLabels = YEARS.map(String);
            const pnlTrendData = { revenue: YEARS.map(y => annualData[y].totalRevenue), expenses: YEARS.map(y => annualData[y].totalExpenses), netResult: YEARS.map(y => annualData[y].netResult) };
            const revenueMixData = {}; LTP_REVENUE_STREAMS.forEach(stream => { revenueMixData[stream.name] = YEARS.map(y => annualData[y].revenues[stream.id] || 0); });
            const expenseMixData = { 'Staff Costs': YEARS.map(y => annualData[y].staffCost) }; LTP_OPCOST_CATEGORIES.forEach(cat => { expenseMixData[cat.name] = YEARS.map(y => annualData[y].opCostsByCategory[cat.id] || 0); });
            const chartColors = ['#65C9C2', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#36A2EB', '#C9CBCF'];
            
            const commonOptions = { responsive: true, maintainAspectRatio: false, animation: { duration: 0 } }; // Disable animation for faster updates

            // P&L Trend Chart
            const pnlCanvas = document.getElementById('ltpPnlTrendChart');
            if (pnlCanvas) { 
                if(activeCharts.ltpPnlTrendChart) activeCharts.ltpPnlTrendChart.destroy(); 
                activeCharts.ltpPnlTrendChart = new Chart(pnlCanvas.getContext('2d'), { 
                    type: 'line', 
                    data: { 
                        labels: chartLabels, 
                        datasets: [ 
                            { label: 'Total Revenue', data: pnlTrendData.revenue, borderColor: chartColors[0], tension: 0.1, fill: false }, 
                            { label: 'Total Expenses', data: pnlTrendData.expenses, borderColor: chartColors[1], tension: 0.1, fill: false }, 
                            { label: 'Net Result', data: pnlTrendData.netResult, borderColor: chartColors[2], tension: 0.1, fill: false, borderDash: [5, 5] } 
                        ] 
                    }, 
                    options: { ...commonOptions, scales: { y: { ticks: { callback: formatSEK_ltp } } } } 
                }); 
            }

            // Revenue Mix Chart
            const revMixCanvas = document.getElementById('ltpRevenueMixChart');
            if(revMixCanvas) { 
                if(activeCharts.ltpRevenueMixChart) activeCharts.ltpRevenueMixChart.destroy(); 
                activeCharts.ltpRevenueMixChart = new Chart(revMixCanvas.getContext('2d'), { 
                    type: 'bar', 
                    data: { 
                        labels: chartLabels, 
                        datasets: Object.keys(revenueMixData).map((key, index) => ({ 
                            label: key, 
                            data: revenueMixData[key], 
                            backgroundColor: chartColors[index % chartColors.length] 
                        })) 
                    }, 
                    options: { ...commonOptions, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: formatSEK_ltp } } } } 
                }); 
            }

            // Expense Mix Chart
            const expMixCanvas = document.getElementById('ltpExpenseMixChart');
            if (expMixCanvas) { 
                if(activeCharts.ltpExpenseMixChart) activeCharts.ltpExpenseMixChart.destroy(); 
                activeCharts.ltpExpenseMixChart = new Chart(expMixCanvas.getContext('2d'), { 
                    type: 'bar', 
                    data: { 
                        labels: chartLabels, 
                        datasets: Object.keys(expenseMixData).map((key, index) => ({ 
                            label: key, 
                            data: expenseMixData[key], 
                            backgroundColor: chartColors[(index + 3) % chartColors.length] // Offset colors
                        })) 
                    }, 
                    options: { ...commonOptions, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: formatSEK_ltp } } } } 
                }); 
            }
        } catch (e) {
            console.error("LTP Script: Error rendering charts:", e);
        }
        console.log("LTP Script: renderLtpCharts - END");
    }

    function renderLtpSummaryPnlTable(annualData) { 
        const tableHead = document.querySelector('#ltpSummaryPnlTable thead tr');
        const tableBody = document.getElementById('ltpSummaryPnlTableBody');
        if (!tableHead || !tableBody) return;
        
        let headHtml = '<th>Description</th>';
        YEARS.forEach(year => headHtml += `<th>${year}</th>`);
        tableHead.innerHTML = headHtml;

        let bodyHtml = '';
        bodyHtml += '<tr><td class="row-header">Total Revenue</td>';
        YEARS.forEach((year, index) => { bodyHtml += `<td>${formatSEK_ltp(annualData[year].totalRevenue)} ${index > 0 && (annualData[YEARS[index-1]].totalRevenue || 0) !==0 ? `<br><span class="yoy-growth">YoY: ${formatPercentage_ltp(((annualData[year].totalRevenue / (annualData[YEARS[index-1]].totalRevenue || 1)) -1)*100)}</span>` : ''}</td>`; });
        bodyHtml += '</tr>';
        bodyHtml += '<tr><td class="row-header" style="padding-left:20px;">Total Staff Costs</td>';
        YEARS.forEach(year => bodyHtml += `<td>${formatSEK_ltp(annualData[year].staffCost)}</td>`);
        bodyHtml += '</tr>';
        bodyHtml += '<tr><td class="row-header" style="padding-left:20px;">Total Operating Costs</td>';
        YEARS.forEach(year => { const totalOp = Object.values(annualData[year].opCostsByCategory).reduce((s,v)=>s+v,0); bodyHtml += `<td>${formatSEK_ltp(totalOp)}</td>`; });
        bodyHtml += '</tr>';
        bodyHtml += '<tr><td class="row-header">Total Expenses</td>';
        YEARS.forEach((year, index) => { bodyHtml += `<td>${formatSEK_ltp(annualData[year].totalExpenses)} ${index > 0 && (annualData[YEARS[index-1]].totalExpenses || 0) !==0 ? `<br><span class="yoy-growth">YoY: ${formatPercentage_ltp(((annualData[year].totalExpenses / (annualData[YEARS[index-1]].totalExpenses || 1)) -1)*100)}</span>` : ''}</td>`; });
        bodyHtml += '</tr>';
        bodyHtml += '<tr style="font-weight:bold; background-color:#f0f7f7;"><td class="row-header">Net Result</td>';
        YEARS.forEach((year) => { bodyHtml += `<td class="${annualData[year].netResult >= 0 ? 'green' : 'red'}">${formatSEK_ltp(annualData[year].netResult)}</td>`; });
        bodyHtml += '</tr>';
        tableBody.innerHTML = bodyHtml;
    }

    function renderLtpCashFlowTable(annualData) { 
        const tableHead = document.querySelector('#ltpCashFlowTable thead tr');
        const tableBody = document.getElementById('ltpCashFlowTableBody');
        if (!tableHead || !tableBody) return;

        let headHtml = '<th>Description</th>'; 
        YEARS.forEach(year => headHtml += `<th>${year}</th>`);
        tableHead.innerHTML = headHtml;
        
        let dashboardStartingCash = 50000; 
        try { 
            const dashboardStateRaw = localStorage.getItem('financialDashboardState'); 
            if (dashboardStateRaw) { const dashboardState = JSON.parse(dashboardStateRaw); dashboardStartingCash = Number(dashboardState.startingCashBalance) || 50000; }
        } catch (e) { console.warn("Could not parse financialDashboardState from localStorage", e); }
        
        let currentOpeningBalance = dashboardStartingCash; 
        let openingBalances = []; 
        let netFlows = []; 
        let closingBalances = [];
        YEARS.forEach(year => { 
            openingBalances.push(currentOpeningBalance); 
            netFlows.push(annualData[year].netResult); 
            const closingBalance = currentOpeningBalance + annualData[year].netResult; 
            closingBalances.push(closingBalance); 
            currentOpeningBalance = closingBalance; 
        });
        
        let bodyHtml = '<tr><td class="row-header">Opening Balance</td>'; 
        openingBalances.forEach(val => bodyHtml += `<td>${formatSEK_ltp(val)}</td>`); 
        bodyHtml += '</tr>';
        
        bodyHtml += '<tr><td class="row-header">Net Cash Flow (from P&L)</td>'; 
        netFlows.forEach(val => bodyHtml += `<td class="${val >= 0 ? 'green' : 'red'}">${formatSEK_ltp(val)}</td>`); 
        bodyHtml += '</tr>';
        
        bodyHtml += '<tr style="font-weight:bold; background-color:#f0f7f7;"><td class="row-header">Closing Balance</td>'; 
        closingBalances.forEach(val => bodyHtml += `<td class="${val >= 0 ? '' : 'red'}">${formatSEK_ltp(val)}</td>`); 
        bodyHtml += '</tr>';
        
        tableBody.innerHTML = bodyHtml;
    }

</script>
</body>
</html>