<!DOCTYPE html>
<html lang="sv-SE">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Innerloom Long-Term Financial Plan (2025-2029) - Final</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css"> <!-- Assuming styles.css contains the main menu CSS -->
  <style>
    body {
      font-family: 'Poppins', sans-serif; background: #f9f9f9; color: #333;
      margin: 0; padding: 0; font-weight: 300;
    }
    .main-menu { /* Basic styling for nav, assuming styles.css has more */
        background-color: #004d40; /* Darker Teal */
        padding: 10px 0;
        text-align: center;
    }
    .main-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: inline-block; /* Align items in a row */
    }
    .main-menu li {
        display: inline-block; /* Align items in a row */
        margin: 0 15px;
    }
    .main-menu a {
        color: white;
        text-decoration: none;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }
    .main-menu a:hover, .main-menu a.active { /* Add .active for current page if desired */
        background-color: #65C9C2; /* Teal */
    }

    .container { max-width: 98%; margin: 20px auto; padding:0 20px; } 
    .page-header { text-align: center; margin-bottom: 25px; }
    .page-header h1 { font-size: 2em; color: #65C9C2; font-weight:700; margin-bottom:5px;}
    .page-header p { font-size: 1em; color: #555; margin-top:0;}

    .section {
      background: #fff; padding: 25px; margin-bottom: 25px;
      border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .section h2 { font-size: 1.4em; margin-bottom: 20px; color: #65C9C2; font-weight:600; border-bottom: 1px solid #e0f2f1; padding-bottom:10px;}
    
    .input-grid-container { overflow-x: auto; }
    .ltp-input-table { width: 100%; min-width: 1600px; border-collapse: collapse; font-size: 0.8em; } 
    .ltp-input-table th, .ltp-input-table td {
      border: 1px solid #e0e0e0; padding: 6px; text-align: right;
    }
    .ltp-input-table th { background-color: #f0f7f7; font-weight: 600; white-space: nowrap; position: sticky; top: 0; z-index:10;}
    .ltp-input-table td input[type="number"] {
      width: 90%; padding: 4px; font-size: 1em; text-align: right; border-radius:3px; border:1px solid #ccc;
      box-sizing: border-box; -moz-appearance: textfield; 
    }
    .ltp-input-table td input[type="number"]::-webkit-outer-spin-button,
    .ltp-input-table td input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none; margin: 0; 
    }
    .ltp-input-table td input.growth-perc-input {
        width: 60px; 
        background-color: #fff9e6; 
    }
    .ltp-input-table .row-header { 
        text-align: left; font-weight: 500; background-color: #f8fbfb; 
        min-width:200px; /* Ensure enough space for longer names */
        position: sticky; left: 0; z-index: 5; 
        background-clip: padding-box; 
    }
    .ltp-input-table .category-header { 
        text-align: left; font-weight: bold; background-color: #e8f8f7; color:#004d40; 
        position: sticky; left:0; z-index:5;
        background-clip: padding-box; 
    }
    .ltp-input-table .year-total-col { font-weight: bold; background-color: #f0f7f7; }
    .ltp-input-table .growth-header-col { background-color: #fff0e0; font-size:0.9em; } 
    
    .summary-pnl-table { width:100%; border-collapse:collapse; margin-top:20px; font-size:0.9em;}
    .summary-pnl-table th, .summary-pnl-table td { border:1px solid #ddd; padding:10px; text-align:right;}
    .summary-pnl-table th { background-color:#e8f8f7; }
    .summary-pnl-table .row-header { text-align:left; font-weight:500;}
    .summary-pnl-table .yoy-growth { font-size:0.8em; color:#777; font-style:italic;}
    .green { color: #28a745 !important; } .red { color: #dc3545 !important; }

    textarea#ltpAssumptions { width: calc(100% - 22px); min-height: 80px; margin-top:10px; padding:10px; border-radius:5px; border:1px solid #ccc; font-size:0.9em;}
    button.control-button {
      padding: 10px 20px; background-color: #65C9C2; color: white; border: none;
      border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: 600;
      margin-top: 15px; margin-right:10px; transition: background-color 0.2s ease;
    }
    button.control-button:hover { background-color: #5ABBAD; }
    .chart-container { 
        margin-top:20px; padding:15px; background-color:#fdfdff; 
        border:1px solid #e0e8e7; border-radius:8px;
        position: relative; 
        height:350px; /* Give charts a fixed height */
    }
    .charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap:20px; } 
    .no-data-warning { color: #a94442; background-color: #f2dede; padding: 15px; border-radius: 5px; text-align: center; margin:15px 0;}
    .nav-links { text-align:center; margin-bottom:20px;}
    .nav-links a { margin:0 10px; color:#65C9C2; text-decoration:none; font-weight:600; }
    .info-text { font-size:0.9em; color: #555; margin-bottom:15px;}
  </style>
</head>
<body>
<nav class="main-menu">
  <ul>
    <li><a href="index.html">Inner Loom Roadmap</a></li>
    <li><a href="funding_strategy.html">Funding Ecosystem</a></li>
    <li><a href="funding_strategy.html">Strategic Drivers</a></li>
    <li><a href="revenue_input.html">Revenue Modeling (Y1)</a></li>
    <li><a href="costs_input.html">Costs Modeling (Y1)</a></li>
    <li><a href="financial_dashboard.html">Financial Dashboard (Y1-Y3)</a></li>
    <li><a href="long_term_planning.html" class="active">Long-Term Plan (5yr)</a></li>
  </ul>
</nav>
<div class="container">
    <div class="page-header">
        <h1>Innerloom Long-Term Financial Plan</h1>
        <p>Quarterly Planning with Growth Drivers (2025 - 2029)</p>
        <div class="nav-links">
            <a href="financial_dashboard.html">Â« Back to Main Dashboard</a>
        </div>
    </div>

    <div id="initialDataWarning" class="no-data-warning" style="display:none;">
        Warning: Year 1 (2025) pre-population requires data from the main Financial Dashboard. Please ensure cost and revenue inputs are saved there.
    </div>

    <div class="section">
        <h2>Overall Long-Term Assumptions & Growth</h2>
        <label for="ltpDefaultGrowthRate">Default Annual Growth Rate for Subsequent Years (%):</label>
        <input type="number" id="ltpDefaultGrowthRate" value="5" style="width:100px; margin-bottom:10px;" onchange="handleDefaultGrowthChange()">
        <textarea id="ltpAssumptions" placeholder="Enter key strategic assumptions for the 2025-2029 period..."></textarea>
    </div>

    <div class="section">
        <h2>Quarterly Input Grid (SEK)</h2>
        <p class="info-text">
            Year 1 (2025) is pre-populated. For subsequent years, the annual total is driven by the previous year's annual total and the "Growth %" input. Quarters are then auto-filled (Annual/4) but can be manually overridden.
            Manually changing a quarterly input will update its year's annual total. To re-apply growth logic for subsequent years based on a manual change, click "Recalculate & Apply All Growth".
        </p>
        <div class="input-grid-container">
            <table class="ltp-input-table" id="ltpInputTable">
                <thead>
                    <tr>
                        <th style="position:sticky; left:0; z-index:20; background-color: #f0f7f7;">Item</th>
                        <!-- Headers will be generated by JS -->
                    </tr>
                </thead>
                <tbody id="ltpInputTableBody">
                    <!-- Rows will be generated by JS -->
                </tbody>
            </table>
        </div>
        <button class="control-button" onclick="saveLtpData()">Save Long-Term Plan</button>
        <button class="control-button" onclick="fullRecalculationFromGrowthInputs()" style="background-color:#5ABBAD;">Recalculate & Apply All Growth</button>
        <button class="control-button" onclick="recalculateAndDisplayLtp()" style="background-color:#778899;">Refresh Summaries & Charts</button>
    </div>

    <div class="section">
        <h2>Long-Term P&L Summary (Annual)</h2>
        <div class="input-grid-container">
            <table class="summary-pnl-table" id="ltpSummaryPnlTable">
                <thead><tr><th>Description</th></tr></thead>
                <tbody id="ltpSummaryPnlTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="section">
        <h2>Long-Term Cash Flow Outlook (Simplified, Annual)</h2>
        <p class="info-text">Based on dashboard's starting cash for 2025, P&L Net Result as proxy for net cash flow.</p>
        <div class="input-grid-container">
            <table class="summary-pnl-table" id="ltpCashFlowTable">
                <thead><tr><th>Description</th></tr></thead>
                <tbody id="ltpCashFlowTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="section">
        <h2>Long-Term Financial Charts</h2>
        <div class="charts-grid">
            <div class="chart-container"><h3>P&L Trend (2025-2029)</h3><canvas id="ltpPnlTrendChart"></canvas></div>
            <div class="chart-container"><h3>Revenue Mix by Year</h3><canvas id="ltpRevenueMixChart"></canvas></div>
            <div class="chart-container"><h3>Expense Mix by Year</h3><canvas id="ltpExpenseMixChart"></canvas></div>
        </div>
    </div>
</div>

<script>
    console.log("LTP Script: Starting execution.");
    // --- Configuration ---
    const START_YEAR = 2025;
    const NUM_YEARS = 5;
    const QUARTERS = ['Q1', 'Q2', 'Q3', 'Q4'];
    const YEARS = Array.from({length: NUM_YEARS}, (_, i) => START_YEAR + i);
    const PROGRAM_FEES_EXPORT_KEY_LTP = 'innerloomCalculatedProgramFees'; // From strategy page
    const PROGRAM_FEES_STREAM_ID_LTP = 'programFees'; // ID for program fees in LTP_REVENUE_STREAMS

    const LTP_REVENUE_STREAMS = [
      { id: 'crowdfunding', name: 'Crowdfunding' }, 
      { id: 'donations', name: 'Donations' },
      { id: 'grants', name: 'Grants' }, 
      { id: PROGRAM_FEES_STREAM_ID_LTP, name: 'Program Fees (Univ. etc.)' }, 
      { id: 'trainTheTrainer', name: 'Train-the-Trainer' }, 
      { id: 'membershipFees', name: 'Membership Fees' },
      { id: 'events', name: 'Events' }, 
      { id: 'otherIncome', name: 'Other Income' }
    ];
    const LTP_OPCOST_CATEGORIES = [
        { id: 'techWeb', name: 'Tech & Web' },
        { id: 'officeAdmin', name: 'Office & Admin' },
        { id: 'profServices', name: 'Prof. Services & Insurance' }
    ];
    const LTP_STAFF_COST_ID = 'totalStaffCosts';
    
    let activeCharts = {}; 
    let isCalculating = false; 

    // --- Helper Functions ---
    function formatSEK_ltp(value) { return (Number(value) || 0).toLocaleString('sv-SE', { style: 'currency', currency: 'SEK', maximumFractionDigits: 0 }); }
    function formatPercentage_ltp(value) { return (Number(value) || 0).toFixed(1) + '%'; }
    function parseFormattedSEK(sekString) {
        if (typeof sekString !== 'string') return 0;
        const numStr = sekString.replace(/[^0-9,.-]/g, '').replace(',', '.'); // Allow minus for parsing
        const num = parseFloat(numStr);
        return Number.isNaN(num) ? 0 : num;
    }

    // --- DOM Ready & Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("LTP Script: DOMContentLoaded event fired.");
        try {
            generateLtpInputTableStructure();
            loadAndPrepopulateLtpData(); 
        } catch (e) {
            console.error("LTP Script: Error during initial DOM setup:", e);
            const warningDiv = document.getElementById('initialDataWarning');
            if(warningDiv) {
                 warningDiv.textContent = "Critical error during page initialization. Check console.";
                 warningDiv.style.display = 'block';
            }
        }
    });

    function generateLtpInputTableStructure() { /* ... Identical to previous correct version ... */ }
    
    function handleQuarterlyInputChange(itemId, year, typePrefix) {
        if (isCalculating) return;
        isCalculating = true;
        console.log(`LTP: Q Input Change - ${itemId} ${year}`);
        try {
            sumQuartersToAnnualAndUpdateDisplay(itemId, year, typePrefix); 
            // When a quarter is manually changed, we re-calculate its annual total.
            // Then, we must ensure that subsequent years that depend on this annual total (via growth %) are updated.
            if (year < YEARS[NUM_YEARS - 1]) {
                propagateGrowthFromYear(itemId, year + 1, typePrefix); 
            }
            recalculateAndDisplayLtp(); 
        } finally {
            isCalculating = false;
        }
    }
    
    function handleGrowthInputChange(itemId, targetYear, typePrefix) {
        if (isCalculating) return;
        isCalculating = true;
        console.log(`LTP: Growth Input Change - ${itemId} ${targetYear}`);
        try {
            propagateGrowthFromYear(itemId, targetYear, typePrefix); 
            recalculateAndDisplayLtp(); 
        } finally {
            isCalculating = false;
        }
    }

    function sumQuartersToAnnualAndUpdateDisplay(itemId, year, typePrefix) { /* ... Identical to previous correct version ... */ }
    function propagateGrowthFromYear(itemId, startPropagationYear, typePrefix) { /* ... Identical to previous correct version, ensure Math.round on quarterlyValue ... */ }
    function handleDefaultGrowthChange() { /* ... Identical to previous correct version ... */ }
    function fullRecalculationFromGrowthInputs() { /* ... Identical to previous correct version ... */ }
    
    function loadAndPrepopulateLtpData() {
        console.log("LTP Script: loadAndPrepopulateLtpData - START");
        if (isCalculating) { console.warn("loadAndPrepopulateLtpData skipped, isCalculating true"); return; }
        isCalculating = true;
        try {
            // --- Y1 (2025) Pre-population from Dashboard Data ---
            const costInputsRaw = JSON.parse(localStorage.getItem('innerloomCostInputs'));
            const revenueInputsAdvancedRaw = JSON.parse(localStorage.getItem('innerloomRevenueInputsAdvanced')); // Y1 monthly revenues
            const warningDiv = document.getElementById('initialDataWarning');
            let y1PrepopulatedSuccessfully = false;

            if (costInputsRaw && revenueInputsAdvancedRaw && revenueInputsAdvancedRaw.monthlyInputs) {
                if(warningDiv) warningDiv.style.display = 'none';
                const netSalaryPerEmp = costInputsRaw.netSalary || 0; 
                const numEmployees = costInputsRaw.numEmployees || 0;
                const avgTaxRate = costInputsRaw.avgIncomeTaxRate || 0;
                const grossSalaryPerEmp = (avgTaxRate < 1 && avgTaxRate > 0 && (1-avgTaxRate) !==0) ? (netSalaryPerEmp / (1 - avgTaxRate)) : netSalaryPerEmp;
                const totalCostPerEmployeeMonthly = grossSalaryPerEmp * (1 + (costInputsRaw.socialSecurityRate||0) + (costInputsRaw.holidayPayRate||0) +
                                                    ((costInputsRaw.includePension ? (costInputsRaw.pensionRate||0) : 0)) + (costInputsRaw.privateInsurancePerc||0));
                const y1AnnualStaffCost = (totalCostPerEmployeeMonthly * numEmployees) * 12;
                const y1StaffCostQuarterly = Math.round(y1AnnualStaffCost / 4);
                QUARTERS.forEach(q => { const el = document.getElementById(`cost_${LTP_STAFF_COST_ID}_${START_YEAR}_${q}`); if(el) el.value = y1StaffCostQuarterly; });
                sumQuartersToAnnualAndUpdateDisplay(LTP_STAFF_COST_ID, START_YEAR, 'cost');

                const opCostMapForCat = { 'techWeb': ['op_email', 'op_canva', 'op_domain', 'op_webDev', 'op_chatgpt'], 'officeAdmin': ['op_bank', 'op_phone', 'op_computer', 'op_office', 'op_supplies', 'op_admin'], 'profServices': ['op_accounting', 'op_insurance']};
                LTP_OPCOST_CATEGORIES.forEach(category => {
                    let catAnnualY1 = 0;
                    if(opCostMapForCat[category.id]){ opCostMapForCat[category.id].forEach(opKey => { catAnnualY1 += (costInputsRaw[opKey] || 0) * 12; }); }
                    const quarterlyVal = Math.round(catAnnualY1 / 4);
                    QUARTERS.forEach(q => { const el = document.getElementById(`cost_${category.id}_${START_YEAR}_${q}`); if(el) el.value = quarterlyVal; });
                    sumQuartersToAnnualAndUpdateDisplay(category.id, START_YEAR, 'cost');
                });

                LTP_REVENUE_STREAMS.forEach(stream => { 
                    if (stream.id !== PROGRAM_FEES_STREAM_ID_LTP) { // Skip program fees for now, handle later
                        const streamData = revenueInputsAdvancedRaw.monthlyInputs[stream.id];
                        const y1AnnualStreamVal = streamData ? streamData.reduce((sum, val) => sum + (val || 0), 0) : 0;
                        const quarterlyVal = Math.round(y1AnnualStreamVal / 4);
                        QUARTERS.forEach(q => { const el = document.getElementById(`rev_${stream.id}_${START_YEAR}_${q}`); if(el) el.value = quarterlyVal; });
                        sumQuartersToAnnualAndUpdateDisplay(stream.id, START_YEAR, 'rev');
                    }
                });
                y1PrepopulatedSuccessfully = true;
                console.log("LTP Script: Y1 Pre-populated from dashboard data (excluding program fees initially).");
            } else {
                if(warningDiv) warningDiv.style.display = 'block';
                console.warn("LTP Script: Y1 Pre-population failed - missing dashboard data.");
            }

            // --- Pre-populate Program Fees from Strategy Page (for all available years) ---
            const programFeesDataRaw = localStorage.getItem(PROGRAM_FEES_EXPORT_KEY_LTP);
            if (programFeesDataRaw) {
                try {
                    const programFeesByYear = JSON.parse(programFeesDataRaw);
                    console.log("LTP Script: Found program fees data from strategy page:", programFeesByYear);
                    YEARS.forEach(year => {
                        if (programFeesByYear[year] !== undefined) {
                            const annualProgramFee = parseFloat(programFeesByYear[year]) || 0;
                            const quarterlyProgramFee = Math.round(annualProgramFee / 4);
                            console.log(`LTP Script: Pre-populating Program Fees for ${year} with Q-val: ${quarterlyProgramFee} (Annual: ${annualProgramFee})`);
                            QUARTERS.forEach(q => {
                                const inputField = document.getElementById(`rev_${PROGRAM_FEES_STREAM_ID_LTP}_${year}_${q}`);
                                if (inputField) inputField.value = quarterlyProgramFee;
                            });
                            sumQuartersToAnnualAndUpdateDisplay(PROGRAM_FEES_STREAM_ID_LTP, year, 'rev');
                        }
                    });
                } catch (e) { console.error("LTP Script: Error processing program fees data from strategy page:", e); }
            } else { console.log("LTP Script: No program fees data found from strategy page."); }


            // --- Load Saved LTP Data (overrides Y1 prepop and program fees prepop if user saved after) ---
            const savedLtp = localStorage.getItem('innerloomLtpData');
            const defaultGrowthRateInput = document.getElementById('ltpDefaultGrowthRate');
            
            if (savedLtp) {
                console.log("LTP Script: Loading saved LTP data.");
                const ltpData = JSON.parse(savedLtp);
                if (ltpData.defaultGrowthRate !== undefined && defaultGrowthRateInput) defaultGrowthRateInput.value = ltpData.defaultGrowthRate;
                
                if (ltpData.inputs) {
                    document.querySelectorAll('.ltp-input-table input[type="number"]').forEach(input => {
                        if (ltpData.inputs[input.id] !== undefined) input.value = ltpData.inputs[input.id];
                    });
                }
                const ltpAssumptionsEl = document.getElementById('ltpAssumptions');
                if (ltpData.assumptions && ltpAssumptionsEl) ltpAssumptionsEl.value = ltpData.assumptions;
            } else {
                console.log("LTP Script: No saved LTP data found. Will apply default growth from UI if not already set.");
                if(defaultGrowthRateInput){ // Ensure all growth inputs get default if no saved data
                    const defaultGrowth = parseFloat(defaultGrowthRateInput.value) || 0;
                    document.querySelectorAll('input.growth-perc-input').forEach(input => {
                         if (input.value === "0") input.value = defaultGrowth; // Only if not already set by a loaded value
                    });
                }
            }
            
            // FINAL STEP: Ensure all annuals are correct and propagate growth based on the final state of inputs
            console.log("LTP Script: Finalizing calculations after load/prepop.");
            fullRecalculationFromGrowthInputs(); 
            
        } catch (e) {
            console.error("LTP Script: Error in loadAndPrepopulateLtpData:", e);
        } finally {
            isCalculating = false;
            console.log("LTP Script: loadAndPrepopulateLtpData - END");
        }
    }

    function saveLtpData() { /* ... Identical to previous correct version ... */ }
    function recalculateAndDisplayLtp() { /* ... Identical to previous correct version (main calc + calls to renderers) ... */ }
    function renderLtpSummaryPnlTable(annualData) { /* ... Identical to previous correct version ... */ }
    function renderLtpCashFlowTable(annualData) { /* ... Identical to previous correct version ... */ }
    function renderLtpCharts(annualData) { /* ... Identical to previous correct version with try-catch and activeCharts usage ... */ }

    // --- Copy ALL rendering functions (renderLtpSummaryPnlTable, renderLtpCashFlowTable, renderLtpCharts) ---
    // --- from the previous "Chart Perfect" response. They are primarily for display ---
    // --- and should be robust if the annualData fed to them is correct. ---
    // (For brevity, not repeating them here, but assume they are copied correctly)
    function renderLtpSummaryPnlTable(annualData) { 
        const tableHead = document.querySelector('#ltpSummaryPnlTable thead tr');
        const tableBody = document.getElementById('ltpSummaryPnlTableBody');
        if (!tableHead || !tableBody) { console.error("Summary PNL table elements not found"); return; }
        
        let headHtml = '<th>Description</th>';
        YEARS.forEach(year => headHtml += `<th>${year}</th>`);
        tableHead.innerHTML = headHtml;

        let bodyHtml = '';
        bodyHtml += '<tr><td class="row-header">Total Revenue</td>';
        YEARS.forEach((year, index) => { 
            const prevYearRevenue = index > 0 ? (annualData[YEARS[index-1]].totalRevenue || 0) : 0;
            const yoyGrowthRev = (index > 0 && prevYearRevenue !== 0) ? formatPercentage_ltp(((annualData[year].totalRevenue / prevYearRevenue) -1)*100) : 'N/A';
            bodyHtml += `<td>${formatSEK_ltp(annualData[year].totalRevenue)} ${index > 0 ? `<br><span class="yoy-growth">YoY: ${yoyGrowthRev}</span>` : ''}</td>`; 
        });
        bodyHtml += '</tr>';
        // ... (rest of the PNL table rows with YoY where applicable) ...
        bodyHtml += '<tr><td class="row-header" style="padding-left:20px;">Total Staff Costs</td>';
        YEARS.forEach(year => bodyHtml += `<td>${formatSEK_ltp(annualData[year].staffCost)}</td>`);
        bodyHtml += '</tr>';
        bodyHtml += '<tr><td class="row-header" style="padding-left:20px;">Total Operating Costs</td>';
        YEARS.forEach(year => { const totalOp = Object.values(annualData[year].opCostsByCategory).reduce((s,v)=>s+v,0); bodyHtml += `<td>${formatSEK_ltp(totalOp)}</td>`; });
        bodyHtml += '</tr>';
        bodyHtml += '<tr><td class="row-header">Total Expenses</td>';
        YEARS.forEach((year, index) => { 
            const prevYearExpenses = index > 0 ? (annualData[YEARS[index-1]].totalExpenses || 0) : 0;
            const yoyGrowthExp = (index > 0 && prevYearExpenses !== 0) ? formatPercentage_ltp(((annualData[year].totalExpenses / prevYearExpenses) -1)*100) : 'N/A';
            bodyHtml += `<td>${formatSEK_ltp(annualData[year].totalExpenses)} ${index > 0 ? `<br><span class="yoy-growth">YoY: ${yoyGrowthExp}</span>` : ''}</td>`; 
        });
        bodyHtml += '</tr>';
        bodyHtml += '<tr style="font-weight:bold; background-color:#f0f7f7;"><td class="row-header">Net Result</td>';
        YEARS.forEach((year) => { bodyHtml += `<td class="${annualData[year].netResult >= 0 ? 'green' : 'red'}">${formatSEK_ltp(annualData[year].netResult)}</td>`; });
        bodyHtml += '</tr>';
        tableBody.innerHTML = bodyHtml;
    }

    function renderLtpCashFlowTable(annualData) { 
        const tableHead = document.querySelector('#ltpCashFlowTable thead tr');
        const tableBody = document.getElementById('ltpCashFlowTableBody');
        if (!tableHead || !tableBody) { console.error("Cash Flow table elements not found"); return; }

        let headHtml = '<th>Description</th>'; 
        YEARS.forEach(year => headHtml += `<th>${year}</th>`);
        tableHead.innerHTML = headHtml;
        
        let dashboardStartingCash = 50000; 
        try { 
            const dashboardStateRaw = localStorage.getItem('financialDashboardState'); // This key should be what financial_dashboard.html uses to save its overall state including starting cash.
            if (dashboardStateRaw) { 
                const dashboardState = JSON.parse(dashboardStateRaw); 
                // Make sure the key 'startingCashBalance' matches what's saved by financial_dashboard.html
                dashboardStartingCash = Number(dashboardState.startingCashBalance) || 50000; 
            }
        } catch (e) { console.warn("Could not parse financialDashboardState from localStorage for LTP starting cash.", e); }
        
        let currentOpeningBalance = dashboardStartingCash; 
        let openingBalances = []; 
        let netFlows = []; 
        let closingBalances = [];
        YEARS.forEach(year => { 
            openingBalances.push(currentOpeningBalance); 
            netFlows.push(annualData[year].netResult); 
            const closingBalance = currentOpeningBalance + annualData[year].netResult; 
            closingBalances.push(closingBalance); 
            currentOpeningBalance = closingBalance; 
        });
        
        let bodyHtml = '<tr><td class="row-header">Opening Balance</td>'; 
        openingBalances.forEach(val => bodyHtml += `<td>${formatSEK_ltp(val)}</td>`); 
        bodyHtml += '</tr>';
        
        bodyHtml += '<tr><td class="row-header">Net Cash Flow (from P&L)</td>'; 
        netFlows.forEach(val => bodyHtml += `<td class="${val >= 0 ? 'green' : 'red'}">${formatSEK_ltp(val)}</td>`); 
        bodyHtml += '</tr>';
        
        bodyHtml += '<tr style="font-weight:bold; background-color:#f0f7f7;"><td class="row-header">Closing Balance</td>'; 
        closingBalances.forEach(val => bodyHtml += `<td class="${val >= 0 ? '' : 'red'}">${formatSEK_ltp(val)}</td>`); 
        bodyHtml += '</tr>';
        
        tableBody.innerHTML = bodyHtml;
    }
    function renderLtpCharts(annualData) { 
        console.log("LTP Script: renderLtpCharts - START");
        try {
            const chartLabels = YEARS.map(String);
            const pnlTrendData = { revenue: YEARS.map(y => annualData[y].totalRevenue), expenses: YEARS.map(y => annualData[y].totalExpenses), netResult: YEARS.map(y => annualData[y].netResult) };
            const revenueMixData = {}; LTP_REVENUE_STREAMS.forEach(stream => { revenueMixData[stream.name] = YEARS.map(y => annualData[y].revenues[stream.id] || 0); });
            const expenseMixData = { 'Staff Costs': YEARS.map(y => annualData[y].staffCost) }; LTP_OPCOST_CATEGORIES.forEach(cat => { expenseMixData[cat.name] = YEARS.map(y => annualData[y].opCostsByCategory[cat.id] || 0); });
            const chartColors = ['#65C9C2', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#36A2EB', '#C9CBCF'];
            
            const commonOptions = { responsive: true, maintainAspectRatio: false, animation: { duration: 0 } };

            const pnlCanvas = document.getElementById('ltpPnlTrendChart');
            if (pnlCanvas) { 
                if(activeCharts.ltpPnlTrendChart) activeCharts.ltpPnlTrendChart.destroy(); 
                activeCharts.ltpPnlTrendChart = new Chart(pnlCanvas.getContext('2d'), { type: 'line', data: { labels: chartLabels, datasets: [ { label: 'Total Revenue', data: pnlTrendData.revenue, borderColor: chartColors[0], tension: 0.1, fill: false }, { label: 'Total Expenses', data: pnlTrendData.expenses, borderColor: chartColors[1], tension: 0.1, fill: false }, { label: 'Net Result', data: pnlTrendData.netResult, borderColor: chartColors[2], tension: 0.1, fill: false, borderDash: [5, 5] } ] }, options: { ...commonOptions, scales: { y: { ticks: { callback: formatSEK_ltp } } } } }); 
            } else { console.warn("LTP PNL Trend Chart canvas not found."); }

            const revMixCanvas = document.getElementById('ltpRevenueMixChart');
            if(revMixCanvas) { 
                if(activeCharts.ltpRevenueMixChart) activeCharts.ltpRevenueMixChart.destroy(); 
                activeCharts.ltpRevenueMixChart = new Chart(revMixCanvas.getContext('2d'), { type: 'bar', data: { labels: chartLabels, datasets: Object.keys(revenueMixData).map((key, index) => ({ label: key, data: revenueMixData[key], backgroundColor: chartColors[index % chartColors.length] })) }, options: { ...commonOptions, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: formatSEK_ltp } } } } }); 
            }  else { console.warn("LTP Revenue Mix Chart canvas not found."); }

            const expMixCanvas = document.getElementById('ltpExpenseMixChart');
            if (expMixCanvas) { 
                if(activeCharts.ltpExpenseMixChart) activeCharts.ltpExpenseMixChart.destroy(); 
                activeCharts.ltpExpenseMixChart = new Chart(expMixCanvas.getContext('2d'), { type: 'bar', data: { labels: chartLabels, datasets: Object.keys(expenseMixData).map((key, index) => ({ label: key, data: expenseMixData[key], backgroundColor: chartColors[(index + 3) % chartColors.length] })) }, options: { ...commonOptions, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: formatSEK_ltp } } } } }); 
            }  else { console.warn("LTP Expense Mix Chart canvas not found."); }
        } catch (e) {
            console.error("LTP Script: Error rendering charts:", e);
        }
        console.log("LTP Script: renderLtpCharts - END");
    }

</script>
</body>
</html>